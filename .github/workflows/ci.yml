name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11", "3.12"]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run tests
        run: pytest tests/ -v --cov=secure_code_reasoner --cov-report=xml

      - name: Run contract tests (non-optional)
        run: pytest tests/test_contracts.py -v --tb=short
        # Contract tests must never be skipped - they prove contracts are active
        # If this step fails, contracts have been weakened or removed

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          fail_ci_if_error: false

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install black mypy ruff

      - name: Run black
        run: black --check src tests

      - name: Run mypy
        run: mypy src

      - name: Run ruff
        run: ruff check src tests

  type-check:
    name: Type Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run mypy
        run: mypy src

  guardrail:
    name: CI Guardrail
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    continue-on-error: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install GitHub CLI
        run: |
          type -p curl >/dev/null || sudo apt-get update && sudo apt-get install -y curl
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt-get update
          sudo apt-get install gh -y

      - name: Verify status contexts
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          COMMIT_SHA="${{ github.sha }}"
          
          # Get all check run names for this commit
          CHECK_RUNS=$(gh api repos/${{ github.repository }}/commits/$COMMIT_SHA/check-runs --jq '.check_runs[] | .name' | sort -u)
          
          # Only check for explicitly forbidden contexts that should never appear on main
          # This guardrail prevents release workflows from blocking main branch pushes
          # Forbidden file patterns (*PROMPT*.md, *EXECUTION*.md, *AUTOMATION*.md) are
          # prevented via repository cleanup policies, not CI checks
          FORBIDDEN_CONTEXTS=("Release" "semantic-release")
          FOUND_FORBIDDEN=""
          
          for check in $CHECK_RUNS; do
            for forbidden in "${FORBIDDEN_CONTEXTS[@]}"; do
              if [[ "$check" == "$forbidden" ]]; then
                FOUND_FORBIDDEN="$FOUND_FORBIDDEN $check"
                break
              fi
            done
          done
          
          if [[ -n "$FOUND_FORBIDDEN" ]]; then
            echo "ERROR: Forbidden status contexts detected on main:$FOUND_FORBIDDEN"
            echo "These contexts should not appear on main branch pushes"
            exit 1
          fi
          
          echo "No forbidden status contexts detected"

  verify-contract:
    name: Verify Contract
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/'))
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Run verification script
        run: |
          chmod +x scripts/verify.sh
          scripts/verify.sh

