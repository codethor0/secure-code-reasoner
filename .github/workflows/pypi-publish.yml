name: PyPI Publish

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  verify-before-publish:
    name: Verify Before Publish
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify tag is signed (via GitHub API)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          
          # Get tag ref to find tag object SHA
          TAG_REF_SHA=$(gh api repos/${{ github.repository }}/git/ref/tags/$TAG_NAME --jq '.object.sha')
          if [ -z "$TAG_REF_SHA" ]; then
            echo "ERROR: Could not resolve tag $TAG_NAME"
            exit 1
          fi
          
          # Get tag object and verify signature via GitHub API
          TAG_VERIFICATION=$(gh api repos/${{ github.repository }}/git/tags/$TAG_REF_SHA --jq '{verified: .verification.verified, reason: .verification.reason}')
          VERIFIED=$(echo "$TAG_VERIFICATION" | jq -r '.verified')
          REASON=$(echo "$TAG_VERIFICATION" | jq -r '.reason')
          
          if [ "$VERIFIED" != "true" ]; then
            echo "ERROR: Tag $TAG_NAME signature verification failed"
            echo "GitHub verification status: verified=$VERIFIED, reason=$REASON"
            exit 1
          fi
          
          echo "Tag $TAG_NAME signature verified via GitHub API (reason: $REASON)"

      - name: Verify working tree is clean
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "ERROR: Working tree is not clean"
            git status --porcelain
            exit 1
          fi
          echo "Working tree is clean"

      - name: Verify no forbidden files
        run: |
          FORBIDDEN_PATTERNS=("*PROMPT*.md" "*EXECUTION*.md" "*AUTOMATION*.md" "*STATUS*.md" "*CHECKLIST*.md" "*MASTER*.md" "*BRANCH_PROTECTION*.md" "TEST.md")
          FOUND=0
          for pattern in "${FORBIDDEN_PATTERNS[@]}"; do
            while IFS= read -r file; do
              filename=$(basename "$file")
              if [[ "$filename" =~ .*PROMPT.*\.md$ ]] || \
                 [[ "$filename" =~ .*EXECUTION.*\.md$ ]] || \
                 [[ "$filename" =~ .*AUTOMATION.*\.md$ ]] || \
                 [[ "$filename" =~ .*STATUS.*\.md$ ]] || \
                 [[ "$filename" =~ .*CHECKLIST.*\.md$ ]] || \
                 [[ "$filename" =~ .*MASTER.*\.md$ ]] || \
                 [[ "$filename" =~ .*BRANCH_PROTECTION.*\.md$ ]] || \
                 [[ "$filename" == "TEST.md" ]]; then
                if [[ ! "$file" =~ ^\.git/ ]] && [[ ! "$file" =~ ^\.github/workflows/ ]]; then
                  echo "ERROR: Forbidden file found: $file"
                  FOUND=1
                fi
              fi
            done < <(git ls-files 2>/dev/null || true)
          done
          if [ $FOUND -eq 1 ]; then
            exit 1
          fi
          echo "No forbidden files found"

      - name: Run verification script
        run: |
          chmod +x scripts/verify.sh
          scripts/verify.sh
        env:
          KEEP_ARTIFACTS: 1

      - name: Verify CI checks passed
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          COMMIT_SHA=$(git rev-parse "$TAG_NAME")
          
          # Wait for CI to complete (with timeout)
          echo "Waiting for CI checks to complete for commit $COMMIT_SHA..."
          MAX_WAIT=600
          ELAPSED=0
          while [ $ELAPSED -lt $MAX_WAIT ]; do
            STATUS=$(gh api repos/${{ github.repository }}/commits/$COMMIT_SHA/check-runs --jq '.check_runs[] | select(.name == "Lint" or .name == "Test (3.11)" or .name == "Test (3.12)" or .name == "Type Check") | .conclusion' | sort -u)
            if echo "$STATUS" | grep -q "success" && ! echo "$STATUS" | grep -q "failure" && ! echo "$STATUS" | grep -q "null"; then
              echo "All required CI checks passed"
              break
            fi
            sleep 10
            ELAPSED=$((ELAPSED + 10))
          done
          
          if [ $ELAPSED -ge $MAX_WAIT ]; then
            echo "ERROR: Timeout waiting for CI checks"
            exit 1
          fi

  build-and-test-publish:
    name: Build and Test Publish (Dry Run)
    runs-on: ubuntu-latest
    needs: verify-before-publish
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          pip install build twine

      - name: Build package
        run: python -m build

      - name: Verify package metadata
        run: |
          python -m twine check dist/*

      - name: Dry-run upload (NO ACTUAL PUBLISH)
        run: |
          echo "DRY-RUN MODE: This would upload to PyPI but is disabled"
          echo "To enable publishing, remove this step and uncomment the real upload step below"
          echo "Package built successfully:"
          ls -lh dist/
          # Uncomment below to enable actual publishing:
          # python -m twine upload dist/* \
          #   --repository-url https://upload.pypi.org/legacy/ \
          #   --username __token__ \
          #   --password ${{ secrets.PYPI_API_TOKEN }} \
          #   --non-interactive
        env:
          PYPI_API_TOKEN: ${{ secrets.PYPI_API_TOKEN }}

      - name: Upload artifacts (for verification)
        uses: actions/upload-artifact@v4
        with:
          name: dist-packages
          path: dist/*
          retention-days: 7
